<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spark Games</title>
  <link rel="shortcut icon" href="assets/favicon.svg" type="image/x-icon" />
  <link rel="stylesheet" href="css/manage-games.css" />
</head>

<body>
  <header class="top" role="banner">
    <div class="topbar">
      <div class="brand">
        <a href="index.html"> Spark Games </a>
      </div>
      <div class="top-actions">
        <button id="openAdd" class="btn" aria-haspopup="dialog">
          Add Game
        </button>
        <button id="logoutBtn" class="btn btn-outline" aria-label="Logout">
          Log out
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section aria-labelledby="manageTitle">
      <h2 id="manageTitle" style="margin: 0 0 12px; font-size: 20px">
        Manage Games
      </h2>

      <div class="filters">
        <div class="catbar" role="tablist" aria-label="Categories">
          <button class="cat-btn active" data-category="all">
            All Games
          </button>
          <button class="cat-btn" data-category="Action">Action</button>
          <button class="cat-btn" data-category="Adventure">Adventure</button>
          <button class="cat-btn" data-category="RPG">RPG</button>
          <button class="cat-btn" data-category="Sports">Sports</button>
          <button class="cat-btn" data-category="Racing">Racing</button>
          <button class="cat-btn" data-category="Strategy">Strategy</button>
          <button class="cat-btn" data-category="Ftrategy">Fighting</button>
        </div>

        <input class="search" id="searchInput" type="search" placeholder="Search by name..."
          aria-label="Search games" />
        <select id="sortSelect" aria-label="Sort games">
          <option value="newest" selected>Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
      </div>

      <div class="table-wrap">
        <table aria-label="Games table">
          <thead>
            <tr>
              <th style="width: 72px">Thumb</th>
              <th>Name</th>
              <th>Price</th>
              <th>Category</th>
              <th style="width: 200px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="loading" class="loading">Loading games...</div>
        <div id="empty" class="empty" style="display: none">
          Game not found
        </div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Game Modal -->
  <div id="addModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle" aria-hidden="true">
    <div class="dialog">
      <header>
        <h3 id="addTitle">Add New Game</h3>
        <button id="closeAdd" class="btn-ghost" aria-label="Close">
          Close
        </button>
      </header>
      <form id="gameForm" novalidate>
        <div class="content">
          <div class="grid">
            <div>
              <label for="gname">Game Name</label>
              <input id="gname" name="gname" type="text" placeholder="Enter game title" required />
            </div>
            <div>
              <label for="price">Price</label>
              <input id="price" name="price" type="number" step="1" min="0" placeholder="200" required />
            </div>
            <div>
              <label for="category">Category</label>
              <select id="category" name="category" required>
                <option value="" selected disabled>Select category</option>
                <option>Action</option>
                <option>Adventure</option>
                <option>RPG</option>
                <option>Sports</option>
                <option>Racing</option>
                <option>Strategy</option>
                <option>Fighting</option>
              </select>
            </div>
            <div>
              <label for="thumbUrl">Thumbnail URL</label>
              <input id="thumbUrl" name="thumbUrl" type="url" placeholder="https://.../thumb.jpg" required />
            </div>
            <!-- Added 4 screenshot input fields -->
            <div>
              <label for="shot1">Screenshot 1 URL</label>
              <input id="shot1" name="shot1" type="url" placeholder="https://.../screenshot1.jpg" required />
            </div>
            <div>
              <label for="shot2">Screenshot 2 URL</label>
              <input id="shot2" name="shot2" type="url" placeholder="https://.../screenshot2.jpg" required />
            </div>
            <div>
              <label for="shot3">Screenshot 3 URL</label>
              <input id="shot3" name="shot3" type="url" placeholder="https://.../screenshot3.jpg" required />
            </div>
            <div>
              <label for="shot4">Screenshot 4 URL</label>
              <input id="shot4" name="shot4" type="url" placeholder="https://.../screenshot4.jpg" required />
            </div>
          </div>

          <label for="desc" style="margin-top: 8px">Description</label>
          <textarea id="desc" name="desc" placeholder="Short description" required></textarea>

          <label for="sys" style="margin-top: 8px">System Requirements</label>
          <textarea id="sys" name="sys" placeholder="CPU, GPU, RAM, Storage, OS..." required></textarea>
        </div>
        <footer>
          <button type="button" id="cancelAdd" class="btn-ghost">
            Cancel
          </button>
          <button class="btn" type="submit" id="submitBtn" aria-label="Add game">
            Save Game
          </button>
        </footer>
      </form>
    </div>
  </div>

  <!-- View Game Modal -->
  <div id="viewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="viewTitle" aria-hidden="true">
    <div class="dialog">
      <header>
        <h3 id="viewTitle">Game Details</h3>
        <button id="closeView" class="btn-ghost" aria-label="Close">
          Close
        </button>
      </header>
      <div class="content">
        <div class="view-body">
          <div>
            <img id="vShot1" class="shot" alt="Game screenshot 1" src="/public/placeholder.jpg" />
          </div>
          <div class="stack">
            <div>
              <span id="vName" class="name"></span>
              <span id="vCat" class="badge"></span>
            </div>
            <div><strong id="vPrice"></strong></div>
            <!-- Removed download link section -->
            <div>
              <div class="muted" style="margin-bottom: 4px">Description</div>
              <div id="vDesc"></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom: 4px">
                System Requirements
              </div>
              <div id="vSys"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Added Edit button in footer -->
      <footer>
        <button id="editBtn" class="btn">Edit</button>
        <button id="closeView2" class="btn-ghost">Close</button>
      </footer>
    </div>
  </div>

  <script>
    const API_BASE_URL = "http://localhost:5000/api";

    // Session guard
    (function guard() {
      const sessionRaw = localStorage.getItem("adminSession");
      if (!sessionRaw) {
        window.location.replace("admin-login.html");
      }
    })();

    let allGames = [];
    let currentEditId = null; // Track which game is being edited

    // Fetch all games from API
    async function fetchGames() {
      try {
        const response = await fetch(
          `https://spark-games-backend.vercel.app/api/get-all`,
        );
        const data = await response.json();

        if (data.success) {
          allGames = data.games.map((g) => ({
            id: g._id,
            name: g.name,
            price: g.price,
            category: g.category,
            description: g.description,
            system: g.systemRequirements,
            thumbUrl: g.thumbnail,
            thumbnail: g.thumbnail,
            screenshot1: g.screenshot1,
            screenshot2: g.screenshot2,
            screenshot3: g.screenshot3,
            screenshot4: g.screenshot4,
            createdAt: new Date(g.createdAt).getTime(),
          }));
          return allGames;
        } else {
          throw new Error(data.message || "Failed to fetch games");
        }
      } catch (error) {
        console.error("Error fetching games:", error);
        alert("Failed to load games. Please check your API connection.");
        return [];
      }
    }

    // Add/Update game via API
    async function addGameAPI(gameData, isEdit = false) {
      try {
        const url = isEdit
          ? `https://spark-games-backend.vercel.app/api/update/${currentEditId}`
          : "https://spark-games-backend.vercel.app/api/add";

        const method = isEdit ? "PUT" : "POST";

        const response = await fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(gameData),
        });

        if (!response.ok) {
          const text = await response.text();
          console.error("Raw response:", text);
          throw new Error("Server returned an error response");
        }

        const data = await response.json();

        if (data.success) {
          alert(isEdit ? "Game updated successfully!" : "Game added successfully!");
          return true;
        } else {
          throw new Error(data.message || "Failed to save game");
        }
      } catch (error) {
        console.error("Error saving game:", error);
        alert("Failed to save game: " + error.message);
        return false;
      }
    }

    // Delete game via API
    async function deleteGameAPI(id) {
      try {
        const response = await fetch(
          `https://spark-games-backend.vercel.app/api/delete/${id}`,
          {
            method: "DELETE",
          },
        );

        const data = await response.json();

        if (data.success) {
          return true;
        } else {
          throw new Error(data.message || "Failed to delete game");
        }
      } catch (error) {
        console.error("Error deleting game:", error);
        alert("Failed to delete game: " + error.message);
        return false;
      }
    }

    const esc = (s = "") =>
      ("" + s).replace(
        /[&<>"']/g,
        (m) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[
          m
          ],
      );

    // Elements
    const tbody = document.getElementById("tbody");
    const emptyEl = document.getElementById("empty");
    const loadingEl = document.getElementById("loading");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const catButtons = Array.from(document.querySelectorAll(".cat-btn"));
    const logoutBtn = document.getElementById("logoutBtn");

    // Add modal elements
    const addModal = document.getElementById("addModal");
    const openAdd = document.getElementById("openAdd");
    const closeAdd = document.getElementById("closeAdd");
    const cancelAdd = document.getElementById("cancelAdd");
    const gameForm = document.getElementById("gameForm");
    const submitBtn = document.getElementById("submitBtn");
    const addTitle = document.getElementById("addTitle");

    // View modal elements
    const viewModal = document.getElementById("viewModal");
    const closeView = document.getElementById("closeView");
    const closeView2 = document.getElementById("closeView2");
    const vShot1 = document.getElementById("vShot1");
    const vName = document.getElementById("vName");
    const vCat = document.getElementById("vCat");
    const vPrice = document.getElementById("vPrice");
    const vDesc = document.getElementById("vDesc");
    const vSys = document.getElementById("vSys");
    const editBtn = document.getElementById("editBtn");

    // State
    let state = { search: "", category: "all", sort: "newest" };

    // Modal helpers
    function openModal(el) {
      el.classList.add("open");
      el.setAttribute("aria-hidden", "false");
    }
    function closeModal(el) {
      el.classList.remove("open");
      el.setAttribute("aria-hidden", "true");
    }

    openAdd.addEventListener("click", () => {
      currentEditId = null;
      addTitle.textContent = "Add New Game";
      submitBtn.textContent = "Save Game";
      gameForm.reset();
      openModal(addModal);
    });
    closeAdd.addEventListener("click", () => closeModal(addModal));
    cancelAdd.addEventListener("click", () => closeModal(addModal));
    addModal.addEventListener("click", (e) => {
      if (e.target === addModal) closeModal(addModal);
    });

    closeView.addEventListener("click", () => closeModal(viewModal));
    closeView2.addEventListener("click", () => closeModal(viewModal));
    viewModal.addEventListener("click", (e) => {
      if (e.target === viewModal) closeModal(viewModal);
    });

    editBtn.addEventListener("click", () => {
      if (!currentEditId) return;
      const g = allGames.find((x) => x.id === currentEditId);
      if (!g) return;

      // Populate form with game data
      document.getElementById("gname").value = g.name || "";
      document.getElementById("price").value = g.price || "";
      document.getElementById("category").value = g.category || "";
      document.getElementById("thumbUrl").value = g.thumbUrl || "";
      document.getElementById("shot1").value = g.screenshot1 || "";
      document.getElementById("shot2").value = g.screenshot2 || "";
      document.getElementById("shot3").value = g.screenshot3 || "";
      document.getElementById("shot4").value = g.screenshot4 || "";
      document.getElementById("desc").value = g.description || "";
      document.getElementById("sys").value = g.system || "";

      addTitle.textContent = "Edit Game";
      submitBtn.textContent = "Update Game";
      closeModal(viewModal);
      openModal(addModal);
    });

    gameForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("gname").value.trim();
      const price = parseFloat(document.getElementById("price").value);
      const category = document.getElementById("category").value;
      const desc = document.getElementById("desc").value.trim();
      const sys = document.getElementById("sys").value.trim();
      const thumbUrl = document.getElementById("thumbUrl").value.trim();
      const shot1 = document.getElementById("shot1").value.trim();
      const shot2 = document.getElementById("shot2").value.trim();
      const shot3 = document.getElementById("shot3").value.trim();
      const shot4 = document.getElementById("shot4").value.trim();

      if (
        !name ||
        !(price >= 0) ||
        !category ||
        !desc ||
        !sys ||
        !thumbUrl ||
        !shot1 ||
        !shot2 ||
        !shot3 ||
        !shot4
      ) {
        alert("Please fill all fields correctly.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = currentEditId ? "Updating..." : "Saving...";

      const gameData = {
        name,
        price,
        category,
        description: desc,
        systemRequirements: sys,
        thumbnail: thumbUrl,
        screenshot1: shot1,
        screenshot2: shot2,
        screenshot3: shot3,
        screenshot4: shot4,
      };

      const success = await addGameAPI(gameData, !!currentEditId);

      if (success) {
        gameForm.reset();
        closeModal(addModal);
        await loadAndRender();
      }

      submitBtn.disabled = false;
      submitBtn.textContent = currentEditId ? "Update Game" : "Save Game";
    });

    async function deleteGame(id) {
      if (!confirm("Are you sure you want to delete this game?")) {
        return;
      }

      const success = await deleteGameAPI(id);
      if (success) {
        await loadAndRender();
      }
    }

    // View game
    function viewGame(id) {
      const g = allGames.find((x) => x.id === id);
      if (!g) return;

      currentEditId = id;

      vShot1.src = g.thumbnail || "/public/placeholder.jpg";
      vShot1.alt = "Screenshot 1 of " + (g.name || "game");

      vName.textContent = g.name || "Unknown Game";
      vCat.textContent = g.category || "N/A";
      vPrice.textContent = "Rs " + (Number(g.price) || 0).toFixed(2);

      const fullDesc = g.description || "";
      const maxWords = 50;
      const descWords = fullDesc.trim().split(/\s+/);
      vDesc.textContent =
        descWords.length > maxWords
          ? descWords.slice(0, maxWords).join(" ") + "..."
          : fullDesc;

      const fullSys = g.system || "";
      const sysWords = fullSys.trim().split(/\s+/);
      vSys.textContent =
        sysWords.length > maxWords
          ? sysWords.slice(0, maxWords).join(" ") + "..."
          : fullSys;

      openModal(viewModal);
    }

    // Filters
    searchInput.addEventListener("input", (e) => {
      state.search = (e.target.value || "").toLowerCase();
      render();
    });
    sortSelect.addEventListener("change", (e) => {
      state.sort = e.target.value;
      render();
    });
    catButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        catButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.category = btn.dataset.category;
        render();
      });
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("adminSession");
      window.location.replace("admin-login.html");
    });

    function render() {
      let list = [...allGames];

      if (state.category !== "all") {
        list = list.filter((g) => g.category === state.category);
      }
      if (state.search) {
        list = list.filter((g) =>
          (g.name || "").toLowerCase().includes(state.search),
        );
      }
      list.sort((a, b) =>
        state.sort === "newest"
          ? b.createdAt - a.createdAt
          : a.createdAt - b.createdAt,
      );

      loadingEl.style.display = "none";

      if (list.length === 0) {
        tbody.innerHTML = "";
        emptyEl.style.display = "block";
        return;
      } else {
        emptyEl.style.display = "none";
      }

      const rows = [];
      for (const g of list) {
        const thumb = esc(g.thumbUrl || g.thumbnail || "");
        rows.push(`
          <tr>
            <td><img class="thumb" src="${thumb || "/public/placeholder.jpg"}" alt="${esc(g.name)} thumbnail" /></td>
            <td><div class="name">${esc(g.name)}</div></td>
            <td>Rs ${Number(g.price).toFixed(2)}</td>
            <td>${esc(g.category)}</td>
            <td>
              <div class="row-actions">
                <button class="btn-ghost" data-view="${g.id}">View</button>
                <button class="btn-danger" data-del="${g.id}">Delete</button>
              </div>
            </td>
          </tr>
        `);
      }
      tbody.innerHTML = rows.join("");

      tbody.querySelectorAll("[data-del]").forEach((el) => {
        el.addEventListener("click", () => deleteGame(el.getAttribute("data-del")));
      });
      tbody.querySelectorAll("[data-view]").forEach((el) => {
        el.addEventListener("click", () => viewGame(el.getAttribute("data-view")));
      });
    }

    async function loadAndRender() {
      loadingEl.style.display = "block";
      emptyEl.style.display = "none";
      tbody.innerHTML = "";

      await fetchGames();
      render();
    }

    loadAndRender();

  </script>
</body>

</html>